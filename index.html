<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz: Estr√©s y Ansiedad</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n de la fuente Inter y colores de Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Color de fondo oscuro */
            color: #e2e8f0; /* Color de texto claro */
        }
        .kahoot-card {
            background-color: #2d3748; /* Color de fondo de las tarjetas */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease-out;
        }
        .answer-button {
            transition: all 0.15s ease-in-out;
        }
        .answer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .correct-answer {
            background-color: #38a169 !important; /* Verde oscuro */
            animation: pulse-correct 0.5s 3;
        }
        .incorrect-answer {
            background-color: #e53e3e !important; /* Rojo oscuro */
            animation: shake 0.5s;
        }
        /* Estilos para el spinner de carga */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #e2e8f0;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-correct {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
    </style>

    <!-- Importar Firebase y librer√≠as de sonido (M√≥dulo) -->
    <script type="module">
        // Importaciones necesarias para Firebase y Tone.js
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, limit, getDocs, addDoc, orderBy, serverTimestamp, deleteDoc, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import * as Tone from "https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js";

        // Exponer m√≥dulos clave al √°mbito global para el script principal
        window.Tone = Tone;
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.query = query;
        window.limit = limit;
        window.getDocs = getDocs;
        window.addDoc = addDoc; 
        window.orderBy = orderBy; 
        window.serverTimestamp = serverTimestamp; 
        window.deleteDoc = deleteDoc;
        window.runTransaction = runTransaction;
        window.writeBatch = writeBatch;
        
        // --- 1. CONFIGURACI√ìN DE FIREBASE (Sincronizaci√≥n de Base de Datos) ---
        // La configuraci√≥n de Firebase (como tu apiKey, projectId, etc.) se carga autom√°ticamente
        // del entorno a trav√©s de la variable __firebase_config.
        const ENVIRONMENT_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const FIREBASE_CONFIG = ENVIRONMENT_CONFIG; 
        
        const appIdForPaths = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- 2. DEFINICI√ìN DE RUTAS P√öBLICAS DE FIRESTORE (Datos Compartidos) ---
        // Estas rutas son para datos p√∫blicos/compartidos (preguntas, leaderboard)
        window.PLAYER_SCORES_COLLECTION_PATH = `/artifacts/${appIdForPaths}/public/data/player_scores`;
        window.QUIZ_QUESTIONS_COLLECTION_PATH = `/artifacts/${appIdForPaths}/public/data/questions`; 
        window.QUIZ_SETTINGS_DOC_PATH = `/artifacts/${appIdForPaths}/public/data/settings/config`; 

        let db, auth, userId = 'anon';

        // Inicializaci√≥n y autenticaci√≥n de Firebase
        window.initFirebase = async () => {
            if (!FIREBASE_CONFIG) {
                console.error("Firebase config is missing.");
                document.getElementById('firebase-status').textContent = '‚ùå Error: Configuraci√≥n de Firebase no encontrada.';
                return;
            }
            try {
                // Inicializa la app de Firebase con la configuraci√≥n del entorno
                const app = initializeApp(FIREBASE_CONFIG);
                // Obtiene la instancia de Firestore (la base de datos)
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentica autom√°ticamente al usuario
                if (initialAuthToken && typeof initialAuthToken === 'string' && initialAuthToken.length > 0) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('firebase-status').textContent = `‚úÖ Sincronizaci√≥n OK. Usuario ID: ${userId.substring(0, 8)}...`; 
                        console.log('Firebase initialized and authenticated. User ID:', userId);
                        // Exponer al √°mbito global
                        window.db = db; // Usado para interactuar con Firestore
                        window.auth = auth;
                        window.userId = userId;
                        // Carga los datos del quiz desde Firestore
                        loadQuizData();
                    } else {
                        console.error("User not signed in.");
                        document.getElementById('firebase-status').textContent = '‚ùå Error de autenticaci√≥n';
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('firebase-status').textContent = `‚ùå Error al cargar Firebase: ${error.code || error.message}`;
            }
        };

        window.initFirebase();
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal de la Aplicaci√≥n -->
    <div id="app-container" class="w-full max-w-lg mx-auto">
        
        <!-- Estado de Firebase (para debug/informaci√≥n) -->
        <p id="firebase-status" class="text-xs text-center mb-2 text-gray-500">Cargando Firebase...</p>

        <!-- Cabecera del Juego (Visible solo en modo Quiz) -->
        <div id="quiz-header" class="flex justify-between items-center mb-6 p-4 rounded-lg bg-gray-700 kahoot-card hidden">
            <div id="score-display" class="text-xl font-bold">Puntos: 0</div>
            <div id="timer-display" class="text-4xl font-black text-yellow-300">30</div>
            <div id="question-counter" class="text-xl font-bold">1 / 4</div>
        </div>

        <!-- PANTALLA 1: INICIO DE JUEGO / REGISTRO DE JUGADOR -->
        <div id="start-screen" class="kahoot-card p-8 rounded-xl text-center">
            <h1 class="text-5xl font-extrabold mb-4 text-pink-400">üß† Quiz de Repaso üí≠</h1>
            <p id="quiz-status-msg" class="text-lg mb-6 text-gray-300">Cargando preguntas y configuraci√≥n...</p>

            <input type="text" id="player-name-input" placeholder="Tu Nombre o Nickname" class="w-full p-3 mb-4 rounded-lg text-lg text-gray-900 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-pink-500"/>
            <p id="name-error" class="text-red-400 text-sm mb-4 hidden">Por favor, introduce un nombre v√°lido.</p>
            
            <button id="start-game-button" onclick="registerPlayer()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                üöÄ ¬°Registrar y Empezar!
            </button>
        </div>

        <!-- PANTALLA 2: QUIZ ACTIVO -->
        <div id="quiz-screen" class="hidden">
            <div id="question-area" class="kahoot-card p-8 rounded-xl mb-4 min-h-[150px] flex items-center justify-center">
                <p id="question-text" class="text-3xl font-bold text-center text-white"></p>
            </div>
            <div id="answers-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- PANTALLA 3: FEEDBACK DE RESPUESTA -->
        <div id="feedback-screen" class="hidden kahoot-card p-12 rounded-xl text-center min-h-[300px] flex flex-col items-center justify-center">
            <p id="feedback-emoji" class="text-6xl mb-4"></p>
            <p id="feedback-text" class="text-3xl font-bold"></p>
            <p id="points-awarded" class="text-xl mt-2 text-gray-300"></p>
        </div>

        <!-- PANTALLA 4: RESULTADOS Y LEADERBOARD -->
        <div id="results-screen" class="hidden kahoot-card p-8 rounded-xl text-center">
            <h2 class="text-4xl font-extrabold mb-4 text-indigo-400">üéâ ¬°Resultados de <span id="player-name-final" class="text-yellow-300"></span>! üéâ</h2>
            <p class="text-6xl font-black text-green-400 mb-8" id="final-score">0</p>
            
            <div class="mb-8 p-4 bg-gray-600 rounded-lg">
                <p class="text-2xl font-bold mb-3 text-pink-300">üèÜ Tabla de Clasificaci√≥n Global</p>
                <div id="leaderboard-list" class="text-left space-y-2">
                    <p class="text-gray-400">Cargando mejores puntuaciones...</p>
                </div>
            </div>

            <button onclick="showScreen('start-screen'); document.getElementById('quiz-header').classList.add('hidden');" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-200">
                üîÑ Jugar de Nuevo
            </button>
        </div>
        
        <!-- PANTALLA 5: ACCESO ADMINISTRADOR (LOGIN) -->
        <div id="admin-login-screen" class="hidden kahoot-card p-8 rounded-xl text-center">
            <h2 class="text-4xl font-extrabold mb-6 text-red-400">üîë Acceso a Administraci√≥n</h2>
            <input type="password" id="admin-password-input" placeholder="Contrase√±a Admin (123)" class="w-full p-3 mb-4 rounded-lg text-lg text-gray-900 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500"/>
            <p id="admin-error" class="text-red-400 text-sm mb-4 hidden">Contrase√±a incorrecta.</p>

            <button onclick="loginAdmin()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-200 w-full mb-3">
                Entrar al Panel
            </button>
            <button onclick="showScreen('start-screen')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full w-full">
                Volver al Inicio
            </button>
        </div>

        <!-- PANTALLA 6: PANEL DE ADMINISTRACI√ìN (DASHBOARD) -->
        <div id="admin-dashboard-screen" class="hidden kahoot-card p-8 rounded-xl">
            <h2 class="text-4xl font-extrabold mb-6 text-green-400 text-center">‚öôÔ∏è Panel de Administraci√≥n</h2>
            
            <div class="space-y-4">
                <button onclick="showAdminQuestions()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg shadow-md w-full text-left flex justify-between items-center">
                    Gestionar Preguntas
                    <span>‚Üí</span>
                </button>
                <button onclick="showAdminSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-lg shadow-md w-full text-left flex justify-between items-center">
                    Configuraci√≥n (Tiempo/Puntos)
                    <span>‚è±Ô∏è</span>
                </button>
                <button onclick="showCSVScreen()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-4 rounded-lg shadow-md w-full text-left flex justify-between items-center">
                    Importar / Exportar CSV
                    <span>‚¨ÜÔ∏è/‚¨áÔ∏è</span>
                </button>
                <button onclick="showResetModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-4 rounded-lg shadow-md w-full text-left flex justify-between items-center">
                    Reiniciar Leaderboard
                    <span>üóëÔ∏è</span>
                </button>
            </div>
            <button onclick="showScreen('start-screen'); isAdmin = false;" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg w-full">
                Cerrar Sesi√≥n / Volver al Inicio
            </button>
        </div>

        <!-- PANTALLA 7: GESTI√ìN DE PREGUNTAS -->
        <div id="admin-questions-screen" class="hidden kahoot-card p-8 rounded-xl">
            <h2 class="text-3xl font-extrabold mb-4 text-yellow-400">üìù Editar Preguntas</h2>

            <!-- Bot√≥n de Volver -->
            <button onclick="showScreen('admin-dashboard-screen')" class="text-blue-400 hover:text-blue-200 mb-4 flex items-center">
                ‚Üê Volver al Dashboard
            </button>
            
            <!-- Lista de Preguntas Actuales -->
            <div id="current-questions-list" class="space-y-4 mb-6 p-4 border border-gray-600 rounded-lg max-h-60 overflow-y-auto">
                <p class="text-gray-400">Cargando preguntas...</p>
            </div>

            <h3 class="text-2xl font-bold mb-3 text-pink-400">A√±adir Nueva Pregunta</h3>
            
            <div id="new-question-form" class="space-y-3">
                <input type="text" id="new-q-text" placeholder="Texto de la Pregunta" class="w-full p-2 rounded text-gray-900 bg-gray-300"/>
                <input type="text" id="new-q-ans0" placeholder="Opci√≥n 1 (Correcta)" class="w-full p-2 rounded bg-green-200 text-gray-900"/>
                <input type="text" id="new-q-ans1" placeholder="Opci√≥n 2" class="w-full p-2 rounded text-gray-900 bg-gray-300"/>
                <input type="text" id="new-q-ans2" placeholder="Opci√≥n 3" class="w-full p-2 rounded text-gray-900 bg-gray-300"/>
                <input type="text" id="new-q-ans3" placeholder="Opci√≥n 4" class="w-full p-2 rounded text-gray-900 bg-gray-300"/>
                <input type="text" id="new-q-emoji" placeholder="Emoji (ej. üß†, opcional)" class="w-full p-2 rounded text-gray-900 bg-gray-300"/>
                <p class="text-sm text-gray-400">La primera opci√≥n (Opci√≥n 1, √≠ndice 0) siempre es la correcta por defecto.</p>
                <p id="question-save-error" class="text-red-400 text-sm hidden">Error al guardar. Aseg√∫rate de llenar el texto y las 4 opciones.</p>
                
                <button onclick="addQuestion()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg w-full">
                    üíæ Guardar Nueva Pregunta
                </button>
            </div>
        </div>
        
        <!-- PANTALLA 8: CONFIGURACI√ìN DE JUEGO (TIEMPO Y PUNTOS) -->
        <div id="admin-settings-screen" class="hidden kahoot-card p-8 rounded-xl">
            <h2 class="text-3xl font-extrabold mb-4 text-blue-400">‚è±Ô∏è Configuraci√≥n de Juego</h2>

            <button onclick="showScreen('admin-dashboard-screen')" class="text-blue-400 hover:text-blue-200 mb-6 flex items-center">
                ‚Üê Volver al Dashboard
            </button>

            <div class="space-y-6">
                <div>
                    <label for="timer-duration-input" class="block text-lg font-medium mb-2 text-gray-300">Duraci√≥n del Cron√≥metro (segundos)</label>
                    <input type="number" id="timer-duration-input" min="5" max="60" class="w-full p-3 rounded-lg text-xl text-gray-900 bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <p class="text-sm text-gray-400 mt-1">Tiempo que tienen los jugadores para responder cada pregunta.</p>
                </div>
                
                <div>
                    <label for="question-points-input" class="block text-lg font-medium mb-2 text-gray-300">Puntos Base por Respuesta Correcta</label>
                    <input type="number" id="question-points-input" min="100" class="w-full p-3 rounded-lg text-xl text-gray-900 bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <p class="text-sm text-gray-400 mt-1">Puntuaci√≥n m√≠nima. La puntuaci√≥n total var√≠a seg√∫n la velocidad.</p>
                </div>

                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg w-full flex items-center justify-center">
                    <span id="settings-loading-icon" class="hidden spinner mr-2"></span>
                    <span id="settings-button-text">üíæ Guardar Configuraci√≥n</span>
                </button>
                <p id="settings-status" class="text-green-400 text-center hidden"></p>
            </div>
        </div>

        <!-- PANTALLA 9: CSV IMPORTAR/EXPORTAR -->
        <div id="admin-csv-screen" class="hidden kahoot-card p-8 rounded-xl">
            <h2 class="text-3xl font-extrabold mb-4 text-teal-400">‚¨ÜÔ∏è/‚¨áÔ∏è Datos CSV</h2>

            <button onclick="showScreen('admin-dashboard-screen')" class="text-blue-400 hover:text-blue-200 mb-6 flex items-center">
                ‚Üê Volver al Dashboard
            </button>
            
            <div class="space-y-6">
                <div class="p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-xl font-bold mb-3">Exportar Preguntas</h3>
                    <p class="mb-3 text-sm text-gray-400">Exporta las preguntas actuales (total: <span id="export-count">0</span>) a un archivo CSV.</p>
                    <button onclick="handleExportQuestions()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg w-full flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Descargar CSV
                    </button>
                </div>

                <div class="p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-xl font-bold mb-3">Importar Preguntas</h3>
                    <p class="mb-3 text-sm text-gray-400">A√±ade nuevas preguntas desde un archivo CSV. <strong class="text-yellow-300">Formato: Texto, Opci√≥n0(Correcta), Opci√≥n1, Opci√≥n2, Opci√≥n3, Emoji.</strong></p>
                    <input type="file" id="csv-file-input" accept=".csv" class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-500 file:text-white hover:file:bg-gray-600"/>
                    <button onclick="handleImportCSV()" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg w-full flex items-center justify-center">
                        <span id="import-loading-icon" class="hidden spinner mr-2"></span>
                        <span id="import-button-text">‚¨ÜÔ∏è Subir e Importar</span>
                    </button>
                    <p id="import-status" class="text-red-400 text-center mt-2 hidden"></p>
                </div>
            </div>
        </div>

    </div>

    <!-- Bot√≥n de Acceso a Admin (siempre visible fuera del admin o quiz) -->
    <div id="admin-access-button" class="fixed bottom-4 right-4 z-10">
        <button onclick="showScreen('admin-login-screen')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition duration-200">
            ‚öôÔ∏è Acceso Admin
        </button>
    </div>

    <!-- Modal de Confirmaci√≥n (gen√©rico, para reinicio y borrado) -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="kahoot-card p-6 rounded-xl w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-red-400"></h3>
            <p id="modal-message" class="mb-4 text-gray-300"></p>
            
            <div class="flex justify-between space-x-3">
                <button onclick="window.currentModalCallback(false)" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition duration-150">Cancelar</button>
                <button id="modal-confirm-button" onclick="window.currentModalCallback(true)" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-150">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Script de la Aplicaci√≥n -->
    <script>
        // --- 1. Definici√≥n Inicial y Variables de Estado ---
        let QUESTIONS = []; 
        let currentQuestionIndex = 0;
        let score = 0;
        let timer = 30; // Valor inicial
        let countdownInterval;
        let isQuestionActive = false;
        let playerName = ''; 
        let isAdmin = false;
        const ADMIN_PASSWORD = '123';
        
        // Configuraci√≥n din√°mica del juego
        let gameConfig = { 
            timerDuration: 30, // Default: 30 segundos
            questionPoints: 1000 // Default: 1000 puntos
        }; 

        // --- 2. Inicializaci√≥n de Sonidos (Tone.js) ---
        let synth;
        let sounds = {};
        let isToneInitialized = false;

        async function initTone() {
            if (isToneInitialized || !window.Tone) return;
            
            try {
                // Activa el AudioContext.
                await window.Tone.start(); 
                
                const PolySynth = window.Tone.PolySynth;
                const Synth = window.Tone.Synth;

                synth = new PolySynth(Synth, {
                    oscillator: { type: "square" },
                    envelope: { release: 0.1 }
                }).toDestination();

                sounds = {
                    correct: () => { synth.triggerAttackRelease(["C5", "E5", "G5"], "8n"); },
                    incorrect: () => { synth.triggerAttackRelease("C3", "4n"); },
                    timerTick: () => { synth.triggerAttackRelease("A2", "32n"); },
                    gameOver: () => { synth.triggerAttackRelease(["C4", "G3", "C3"], "1n", "+0.1"); }
                };
                isToneInitialized = true;
            } catch (error) {
                console.error("Error during Tone.js initialization:", error);
            }
        }
        
        // --- 3. Funciones de Control de Pantalla y UI ---
        
        function showScreen(screenId) {
            const screens = [
                'start-screen', 'quiz-screen', 'feedback-screen', 'results-screen', 
                'admin-login-screen', 'admin-dashboard-screen', 'admin-questions-screen',
                'admin-settings-screen', 'admin-csv-screen'
            ];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            document.getElementById(screenId).classList.remove('hidden');

            // Mostrar/Ocultar cabecera del quiz y bot√≥n de admin
            const quizHeader = document.getElementById('quiz-header');
            const adminButton = document.getElementById('admin-access-button');
            
            if (screenId === 'quiz-screen' || screenId === 'feedback-screen') {
                quizHeader.classList.remove('hidden');
                adminButton.classList.add('hidden');
            } else {
                quizHeader.classList.add('hidden');
                // Ocultar el bot√≥n de Admin si estamos en una pantalla de Admin
                if (screenId.startsWith('admin-') && screenId !== 'admin-login-screen') {
                    adminButton.classList.add('hidden');
                } else {
                    adminButton.classList.remove('hidden');
                }
            }
            
            // Si volvemos a la pantalla de inicio, recargamos la configuraci√≥n por si cambi√≥
            if (screenId === 'start-screen') {
                loadQuizData(); 
            }
        }

        function updateUI() {
            document.getElementById('question-counter').textContent = `${currentQuestionIndex + 1} / ${QUESTIONS.length}`;
            document.getElementById('score-display').textContent = `Puntos: ${score}`;
        }
        
        // --- 4. L√≥gica de Administraci√≥n (Login, CRUD, Configuraci√≥n) ---
        
        // Funci√≥n para mostrar el modal de confirmaci√≥n
        window.showConfirmationModal = function(title, message, confirmButtonText, callback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-button').textContent = confirmButtonText;
            window.currentModalCallback = (result) => {
                document.getElementById('confirmation-modal').classList.add('hidden');
                callback(result);
            };
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        window.loginAdmin = function() {
            const inputElement = document.getElementById('admin-password-input');
            const errorElement = document.getElementById('admin-error');
            
            if (inputElement.value === ADMIN_PASSWORD) {
                isAdmin = true;
                errorElement.classList.add('hidden');
                inputElement.value = ''; 
                showScreen('admin-dashboard-screen');
            } else {
                errorElement.classList.remove('hidden');
                inputElement.classList.add('border-2', 'border-red-500');
                setTimeout(() => inputElement.classList.remove('border-2', 'border-red-500'), 1500);
            }
        }

        window.showAdminQuestions = function() {
            if (isAdmin) {
                showScreen('admin-questions-screen');
                renderAdminQuestions();
            }
        }
        
        window.showAdminSettings = function() {
            if (isAdmin) {
                // Rellenar inputs con la configuraci√≥n actual antes de mostrar
                document.getElementById('timer-duration-input').value = gameConfig.timerDuration;
                document.getElementById('question-points-input').value = gameConfig.questionPoints;
                showScreen('admin-settings-screen');
            }
        }

        window.showCSVScreen = function() {
             if (isAdmin) {
                document.getElementById('export-count').textContent = QUESTIONS.length;
                showScreen('admin-csv-screen');
            }
        }

        // --- CARGA DE DATOS (PREGUNTAS Y CONFIGURACI√ìN) ---

        const DEFAULT_SETTINGS = { timerDuration: 30, questionPoints: 1000 };

        async function loadQuizData() {
            const statusMsg = document.getElementById('quiz-status-msg');
            const startBtn = document.getElementById('start-game-button');
            startBtn.disabled = true;
            
            // Verificamos que la instancia de Firestore (db) est√© disponible, lo que confirma la sincronizaci√≥n.
            if (!window.db) {
                statusMsg.textContent = "Error: Base de datos no disponible.";
                return;
            }

            try {
                // 1. Cargar Configuraci√≥n
                const configDocRef = doc(window.db, window.QUIZ_SETTINGS_DOC_PATH);
                const configSnap = await window.getDoc(configDocRef);
                
                if (configSnap.exists()) {
                    gameConfig = { ...DEFAULT_SETTINGS, ...configSnap.data() };
                } else {
                    // Inicializar si no existe
                    await window.setDoc(configDocRef, DEFAULT_SETTINGS);
                    gameConfig = DEFAULT_SETTINGS;
                }
                
                // Actualizar timer inicial con la configuraci√≥n cargada
                document.getElementById('timer-display').textContent = gameConfig.timerDuration;
                timer = gameConfig.timerDuration;

                // 2. Cargar Preguntas
                // Accede a la colecci√≥n de preguntas de la base de datos sincronizada
                const q = query(collection(window.db, window.QUIZ_QUESTIONS_COLLECTION_PATH), orderBy('timestamp', 'asc'));
                const snapshot = await window.getDocs(q);
                
                QUESTIONS = [];
                snapshot.forEach(doc => {
                    QUESTIONS.push({ ...doc.data(), docId: doc.id }); 
                });

                if (QUESTIONS.length === 0) {
                    statusMsg.textContent = "¬°Cargado! No hay preguntas. Usa el Panel Admin para a√±adir.";
                } else {
                    statusMsg.textContent = `¬°Cargado! ${QUESTIONS.length} preguntas disponibles.`;
                }
                
                startBtn.disabled = (QUESTIONS.length === 0);

            } catch (e) {
                console.error("Error al cargar datos del quiz:", e);
                statusMsg.textContent = `Error al cargar datos: ${e.message}.`;
                startBtn.disabled = true;
            }
        }
        
        // --- GESTI√ìN DE PREGUNTAS EN FIRESTORE ---

        function renderAdminQuestions() {
            const list = document.getElementById('current-questions-list');
            list.innerHTML = ''; 
            
            if (QUESTIONS.length === 0) {
                list.innerHTML = '<p class="text-gray-400">No hay preguntas cargadas.</p>';
                return;
            }

            QUESTIONS.forEach((q, index) => {
                const correctText = q.answers[q.correctIndex || 0];
                const item = document.createElement('div');
                item.className = 'p-3 bg-gray-600 rounded-lg flex justify-between items-start';
                item.innerHTML = `
                    <div class="flex-1 mr-4">
                        <p class="font-bold text-yellow-300">${index + 1}. ${q.text}</p>
                        <p class="text-sm text-green-300">Respuesta: ${correctText}</p>
                    </div>
                    <button onclick="deleteQuestion('${q.docId}')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md text-sm ml-2">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
        }
        
        window.addQuestion = async function() {
            const text = document.getElementById('new-q-text').value.trim();
            const answers = [
                document.getElementById('new-q-ans0').value.trim(),
                document.getElementById('new-q-ans1').value.trim(),
                document.getElementById('new-q-ans2').value.trim(),
                document.getElementById('new-q-ans3').value.trim()
            ];
            const emoji = document.getElementById('new-q-emoji').value.trim() || '‚ùì';
            
            const errorElement = document.getElementById('question-save-error');
            errorElement.classList.add('hidden');

            if (!text || answers.some(a => !a)) {
                errorElement.classList.remove('hidden');
                return;
            }

            const newQuestion = {
                text: text,
                answers: answers, 
                correctIndex: 0, // Opci√≥n 1 (√≠ndice 0) siempre es la correcta
                emoji: emoji,
                timestamp: window.serverTimestamp()
            };

            try {
                // Sincroniza la nueva pregunta con Firestore
                await window.addDoc(collection(window.db, window.QUIZ_QUESTIONS_COLLECTION_PATH), newQuestion);
                
                // Recargar y actualizar vistas
                await loadQuizData();
                renderAdminQuestions();

                // Limpiar formulario
                document.querySelectorAll('#new-question-form input').forEach(input => input.value = '');
                errorElement.textContent = "Pregunta guardada exitosamente.";
                errorElement.classList.remove('hidden');
                errorElement.classList.remove('text-red-400');
                errorElement.classList.add('text-green-400');
            } catch (e) {
                console.error("Error al a√±adir pregunta:", e);
                errorElement.textContent = "Error al guardar: " + e.message;
                errorElement.classList.remove('hidden');
                errorElement.classList.add('text-red-400');
                errorElement.classList.remove('text-green-400');
            }
        }

        window.deleteQuestion = function(docId) {
            window.showConfirmationModal(
                "Eliminar Pregunta", 
                "¬øEst√°s seguro de que quieres eliminar esta pregunta? Esta acci√≥n es irreversible.",
                "Eliminar",
                async (confirmed) => {
                    if (!confirmed) return;
                    
                    try {
                        const docRef = doc(window.db, window.QUIZ_QUESTIONS_COLLECTION_PATH, docId);
                        // Sincroniza la eliminaci√≥n con Firestore
                        await window.deleteDoc(docRef);
                        await loadQuizData();
                        renderAdminQuestions();
                        console.log(`Pregunta ${docId} eliminada.`);
                    } catch (e) {
                        console.error("Error al eliminar pregunta:", e);
                        // NOTA: Usar custom modal en lugar de alert
                        console.error("Error al eliminar la pregunta de la base de datos.");
                    }
                }
            );
        }

        // --- GESTI√ìN DE CONFIGURACI√ìN ---

        window.saveSettings = async function() {
            if (!window.db) return;
            
            const timerInput = document.getElementById('timer-duration-input');
            const pointsInput = document.getElementById('question-points-input');
            const status = document.getElementById('settings-status');
            const buttonText = document.getElementById('settings-button-text');
            const loadingIcon = document.getElementById('settings-loading-icon');

            const newTimer = parseInt(timerInput.value, 10);
            const newPoints = parseInt(pointsInput.value, 10);

            if (isNaN(newTimer) || newTimer < 5 || isNaN(newPoints) || newPoints < 100) {
                status.textContent = "üö® Valores no v√°lidos. El tiempo debe ser >= 5s y los puntos >= 100.";
                status.classList.remove('hidden', 'text-green-400');
                status.classList.add('text-red-400');
                return;
            }

            loadingIcon.classList.remove('hidden');
            buttonText.textContent = 'Guardando...';
            status.classList.add('hidden');

            const newConfig = {
                timerDuration: newTimer,
                questionPoints: newPoints
            };
            
            try {
                const configDocRef = doc(window.db, window.QUIZ_SETTINGS_DOC_PATH);
                // Sincroniza la configuraci√≥n con Firestore
                await window.setDoc(configDocRef, newConfig);
                gameConfig = newConfig; // Actualizar localmente
                status.textContent = "‚úÖ Configuraci√≥n guardada con √©xito!";
                status.classList.remove('text-red-400');
                status.classList.add('text-green-400');
            } catch (e) {
                console.error("Error al guardar configuraci√≥n:", e);
                status.textContent = "‚ùå Error al guardar: " + e.message;
                status.classList.remove('text-green-400');
                status.classList.add('text-red-400');
            } finally {
                loadingIcon.classList.add('hidden');
                buttonText.textContent = 'üíæ Guardar Configuraci√≥n';
                status.classList.remove('hidden');
            }
        }

        // --- GESTI√ìN DE CSV ---

        // Helper para convertir el array de preguntas a CSV
        function questionsToCSV(questions) {
            const headers = ["Texto", "Opci√≥n0 (Correcta)", "Opci√≥n1", "Opci√≥n2", "Opci√≥n3", "Emoji", "√çndice Correcto"];
            const csvRows = [];
            
            questions.forEach(q => {
                const row = [
                    `"${q.text.replace(/"/g, '""')}"`,
                    ...q.answers.map(a => `"${a.replace(/"/g, '""')}"`),
                    q.emoji || '',
                    q.correctIndex || 0
                ];
                csvRows.push(row.join(','));
            });

            return [headers.join(','), ...csvRows].join('\n');
        }
        
        // Helper para parsear CSV a preguntas
        function CSVToQuestions(csvText) {
            const lines = csvText.trim().split('\n');
            // Ignorar la primera l√≠nea si es un encabezado
            const dataLines = lines[0].toLowerCase().includes('texto') ? lines.slice(1) : lines;
            const newQuestions = [];

            for (let i = 0; i < dataLines.length; i++) {
                const line = dataLines[i];
                if (line.trim() === '') continue;

                // Patr√≥n simple para manejar campos entre comillas
                const fields = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];

                if (fields.length < 5) { // M√≠nimo: Texto, 4 Opciones
                    throw new Error(`Error en l√≠nea ${i + 1}: Se requieren al menos 5 campos (Texto + 4 Opciones).`);
                }
                
                // Des-escapar y limpiar campos
                const cleanFields = fields.map(f => f.replace(/^"|"$/g, '').replace(/""/g, '"').trim());

                const [text, ans0, ans1, ans2, ans3, emoji, ...rest] = cleanFields;
                
                // Por convenci√≥n, Opci√≥n 1 (ans0) es la correcta, index=0
                const question = {
                    text: text || 'Pregunta Importada',
                    answers: [ans0, ans1, ans2, ans3],
                    correctIndex: 0, 
                    emoji: emoji && emoji.length < 5 ? emoji : '‚ùì',
                    timestamp: window.serverTimestamp() // Se a√±adir√° al guardar
                };
                
                newQuestions.push(question);
            }
            return newQuestions;
        }

        window.handleExportQuestions = function() {
            if (QUESTIONS.length === 0) {
                console.error("No hay preguntas para exportar.");
                // NOTA: Usar custom modal en lugar de alert
                return;
            }
            const csv = questionsToCSV(QUESTIONS);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `quiz_preguntas_${new Date().getTime()}.csv`);
            a.click();
            URL.revokeObjectURL(url);
            console.log(`Exportadas ${QUESTIONS.length} preguntas.`);
        }

        window.handleImportCSV = function() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            const status = document.getElementById('import-status');
            const buttonText = document.getElementById('import-button-text');
            const loadingIcon = document.getElementById('import-loading-icon');

            status.classList.add('hidden');
            if (!file) {
                status.textContent = "üö® Por favor, selecciona un archivo CSV.";
                status.classList.remove('hidden');
                return;
            }

            loadingIcon.classList.remove('hidden');
            buttonText.textContent = 'Procesando...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csvText = e.target.result;
                    const newQuestions = CSVToQuestions(csvText);

                    if (newQuestions.length === 0) {
                        throw new Error("El archivo no contiene preguntas v√°lidas.");
                    }

                    // Usar Batch para a√±adir m√∫ltiples documentos
                    const batch = window.writeBatch(window.db);
                    const questionsCollectionRef = collection(window.db, window.QUIZ_QUESTIONS_COLLECTION_PATH);

                    newQuestions.forEach(q => {
                        const docRef = doc(questionsCollectionRef);
                        batch.set(docRef, q);
                    });

                    // Sincroniza la adici√≥n masiva con Firestore
                    await batch.commit();

                    await loadQuizData();
                    status.textContent = `‚úÖ Importaci√≥n exitosa. Se a√±adieron ${newQuestions.length} preguntas.`;
                    status.classList.remove('text-red-400');
                    status.classList.add('text-green-400');
                } catch (error) {
                    console.error("Error al importar CSV:", error);
                    status.textContent = `‚ùå Error de importaci√≥n: ${error.message}`;
                    status.classList.remove('text-green-400');
                    status.classList.add('text-red-400');
                } finally {
                    loadingIcon.classList.add('hidden');
                    buttonText.textContent = '‚¨ÜÔ∏è Subir e Importar';
                    status.classList.remove('hidden');
                    fileInput.value = ''; // Limpiar input file
                }
            };
            reader.readAsText(file);
        }

        // --- REINICIO DE LEADERBOARD ---

        window.showResetModal = function() {
            if (isAdmin) {
                window.showConfirmationModal(
                    "üö® Confirmar Reinicio de Leaderboard", 
                    "Esta acci√≥n es irreversible y eliminar√° **TODAS** las puntuaciones. ¬øEst√°s seguro?",
                    "Confirmar Borrado",
                    (confirmed) => {
                        if (confirmed) resetLeaderboard();
                    }
                );
            }
        }

        async function resetLeaderboard() {
            if (!window.db) { console.error("La base de datos de Firebase no est√° lista."); return; } 
            
            const statusDisplay = document.getElementById('firebase-status');
            statusDisplay.textContent = '‚ö†Ô∏è Reiniciando Leaderboard. Por favor, espera...'; 
            
            try {
                const q = query(collection(window.db, window.PLAYER_SCORES_COLLECTION_PATH));
                const snapshot = await window.getDocs(q);
                
                // Usa una transacci√≥n para eliminar en lote y garantizar la sincronizaci√≥n
                const deleteCount = await window.runTransaction(window.db, async (transaction) => {
                    let count = 0;
                    snapshot.forEach((doc) => {
                        transaction.delete(doc.ref);
                        count++;
                    });
                    return count;
                });
                
                console.log(`√âxito: Se eliminaron ${deleteCount} documentos del leaderboard.`);
                statusDisplay.textContent = `‚úÖ Leaderboard reiniciado (${deleteCount} documentos borrados). ID: ${window.userId.substring(0, 8)}...`;

                if (!document.getElementById('results-screen').classList.contains('hidden')) {
                    loadLeaderboard(); 
                }

            } catch (e) {
                console.error("Error al reiniciar la tabla de clasificaci√≥n:", e);
                statusDisplay.textContent = `‚ùå Error al reiniciar: ${e.message}`;
            }
        }
        
        // --- 5. L√≥gica del Quiz y Puntuaci√≥n ---
        
        window.registerPlayer = function() {
            const inputElement = document.getElementById('player-name-input');
            const errorElement = document.getElementById('name-error');
            
            playerName = inputElement.value.trim();

            if (playerName.length < 2) {
                errorElement.textContent = "Introduce un nombre v√°lido.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('border-2', 'border-red-500');
                return;
            }
            if (QUESTIONS.length === 0) {
                errorElement.textContent = "No hay preguntas cargadas. Contacta al administrador.";
                errorElement.classList.remove('hidden');
                return;
            }
            
            errorElement.classList.add('hidden');
            inputElement.classList.remove('border-2', 'border-red-500');
            
            startGame();
        }

        function startGame() {
            initTone(); 
            score = 0;
            currentQuestionIndex = 0;
            // Configurar el timer para el juego
            timer = gameConfig.timerDuration; 
            document.getElementById('timer-display').textContent = timer; 
            
            updateUI();
            showScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= QUESTIONS.length) {
                return showResults();
            }

            showScreen('quiz-screen');
            isQuestionActive = true;

            const questionData = QUESTIONS[currentQuestionIndex];
            document.getElementById('question-text').textContent = `${questionData.emoji} ${questionData.text}`;
            
            const answersGrid = document.getElementById('answers-grid');
            answersGrid.innerHTML = '';
            
            const colors = ["bg-green-500", "bg-red-500", "bg-blue-500", "bg-yellow-500"];
            const shapes = ["‚ñ≤", "‚óÜ", "‚óè", "‚óºÔ∏è"];

            const originalAnswers = questionData.answers;
            const correctText = originalAnswers[questionData.correctIndex || 0]; 
            
            const mixedAnswers = originalAnswers.map((text) => ({
                text: text,
                isCorrect: text === correctText
            }));

            // Funci√≥n para mezclar (Fisher-Yates)
            for (let i = mixedAnswers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [mixedAnswers[i], mixedAnswers[j]] = [mixedAnswers[j], mixedAnswers[i]];
            }

            mixedAnswers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.innerHTML = `<span class="text-xl mr-2">${shapes[index]}</span> ${answer.text}`;
                button.className = `answer-button ${colors[index]} text-white font-bold p-4 rounded-xl text-left shadow-md transform transition duration-150`;
                button.onclick = () => handleAnswer(answer.isCorrect, button, originalAnswers.indexOf(correctText));
                answersGrid.appendChild(button);
            });

            resetTimer();
            startTimer();
        }

        function resetTimer() {
            clearInterval(countdownInterval);
            timer = gameConfig.timerDuration;
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.textContent = timer;
            timerDisplay.classList.remove('text-red-500', 'animate-pulse');
            timerDisplay.classList.add('text-yellow-300');
        }

        function startTimer() {
            countdownInterval = setInterval(() => {
                timer--;
                const timerDisplay = document.getElementById('timer-display');
                timerDisplay.textContent = timer;
                
                if (timer <= 5) {
                    timerDisplay.classList.add('text-red-500', 'animate-pulse');
                    if (isToneInitialized) sounds.timerTick();
                }

                if (timer <= 0) {
                    clearInterval(countdownInterval);
                    handleAnswer(false, null, 0); // Tiempo agotado
                }
            }, 1000);
        }

        window.handleAnswer = function(isCorrect, selectedButton, correctOriginalIndex) {
            if (!isQuestionActive) return; 
            isQuestionActive = false;
            clearInterval(countdownInterval);
            
            const questionData = QUESTIONS[currentQuestionIndex];
            const correctText = questionData.answers[correctOriginalIndex];

            let points = 0;

            const allButtons = document.getElementById('answers-grid').querySelectorAll('button');
            allButtons.forEach(button => button.onclick = null);

            let correctAnswerButton = null;
            allButtons.forEach(button => {
                if (button.textContent.includes(correctText)) {
                    correctAnswerButton = button;
                }
            });
            
            if (isCorrect) {
                // C√°lculo de puntos din√°mico basado en la configuraci√≥n
                const basePoints = gameConfig.questionPoints;
                const timeFactor = timer / gameConfig.timerDuration;
                points = basePoints + Math.floor(timeFactor * basePoints); // M√°ximo 2x los puntos base
                score += points;
                
                if (selectedButton) selectedButton.classList.add('correct-answer');
                if (isToneInitialized) sounds.correct();
                displayFeedback("¬°Correcto! üéâ", `Ganaste ${points} puntos.`, 'text-green-400');
            } else {
                if (selectedButton) selectedButton.classList.add('incorrect-answer');
                if (correctAnswerButton) correctAnswerButton.classList.add('correct-answer');
                
                if (isToneInitialized) sounds.incorrect();
                displayFeedback(selectedButton ? "¬°Incorrecto! üò•" : "¬°Tiempo Agotado! ‚è±Ô∏è", "La respuesta correcta se marca en verde.", 'text-red-400');
            }

            updateUI();
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 2500); 
        }

        function displayFeedback(emoji, text, colorClass) {
            document.getElementById('feedback-emoji').textContent = emoji;
            document.getElementById('feedback-text').textContent = text;
            document.getElementById('feedback-text').className = `text-3xl font-bold ${colorClass}`;
            document.getElementById('points-awarded').textContent = text.includes('Ganaste') ? text : '';
            showScreen('feedback-screen');
        }

        function showResults() {
            if (isToneInitialized) sounds.gameOver();
            document.getElementById('final-score').textContent = score;
            document.getElementById('player-name-final').textContent = playerName; 
            showScreen('results-screen');
            savePlayerScore(); 
            loadLeaderboard(); 
        }

        // --- 6. L√≥gica de Puntuaci√≥n Alta (Firestore) ---

        const PLAYER_SCORES_COLLECTION = window.PLAYER_SCORES_COLLECTION_PATH; 

        window.loadLeaderboard = async function() {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '<p class="text-gray-400">Cargando mejores puntuaciones...</p>'; 

            if (!window.db) {
                 leaderboardList.innerHTML = '<p class="text-red-400">Error: Base de datos no disponible.</p>';
                 return;
            } 
            
            try {
                // Consulta el leaderboard, sincronizando los datos en tiempo real
                const q = query(
                    collection(window.db, PLAYER_SCORES_COLLECTION),
                    window.orderBy('score', 'desc'),
                    window.orderBy('timestamp', 'asc'), 
                    window.limit(10)
                );

                const querySnapshot = await window.getDocs(q);
                
                let htmlContent = '';
                
                if (querySnapshot.empty) {
                    htmlContent = '<p class="text-gray-400">S√© el primero en jugar y registrar tu puntuaci√≥n.</p>';
                } else {
                    querySnapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const rank = index + 1;
                        const rankColor = rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-gray-300' : rank === 3 ? 'text-amber-600' : 'text-gray-100';
                        
                        // Resaltar la puntuaci√≥n del jugador actual si es el mismo usuario y nombre/puntuaci√≥n
                        const highlightClass = data.userId === window.userId && data.playerName === playerName && data.score === score ? 'bg-indigo-700 p-2 rounded-lg font-bold' : 'p-2';

                        htmlContent += `
                            <div class="flex justify-between items-center ${highlightClass} transition duration-150">
                                <span class="font-black ${rankColor} w-1/6">${rank}.</span>
                                <span class="w-3/6 truncate">${data.playerName || 'An√≥nimo'}</span>
                                <span class="font-extrabold w-2/6 text-right">${data.score} Puntos</span>
                            </div>
                        `;
                    });
                }
                
                leaderboardList.innerHTML = htmlContent;

            } catch (e) {
                console.error("Error al cargar la tabla de clasificaci√≥n:", e);
                leaderboardList.innerHTML = '<p class="text-red-400">Error: Base de datos no disponible.</p>';
            }
        }

        function savePlayerScore() {
            if (!window.db || !window.userId || !playerName || !window.serverTimestamp) {
                console.warn("No se puede guardar la puntuaci√≥n. Faltan datos (DB, ID de Usuario, Nombre o serverTimestamp).");
                return;
            }

            try {
                const collectionRef = collection(window.db, PLAYER_SCORES_COLLECTION);
                
                const scoreData = {
                    score: score,
                    playerName: playerName,
                    userId: window.userId,
                    timestamp: window.serverTimestamp() 
                };
                
                // Sincroniza la nueva puntuaci√≥n del jugador con Firestore
                window.addDoc(collectionRef, scoreData)
                    .then(() => {
                        console.log("Puntuaci√≥n del jugador guardada exitosamente:", score);
                    })
                    .catch(e => {
                        console.error("Error al guardar la puntuaci√≥n del jugador:", e);
                    });

            } catch (e) {
                console.error("Error general en savePlayerScore:", e);
            }
        }
        
        // Llamada inicial al cargar la ventana
        window.onload = () => {
             showScreen('start-screen'); 
        };

    </script>
</body>
</html>
